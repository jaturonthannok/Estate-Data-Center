<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Simple Land Finder</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
  :root{
    --bg:#f6f8fb;
    --card:#ffffff;
    --text:#0f172a;
    --muted:#64748b;
    --border:#e2e8f0;
    --primary:#0b74de;
    --primary2:#095db1;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Noto Sans",sans-serif;
    background:var(--bg);
    color:var(--text);
  }
  header{
    background:linear-gradient(90deg,var(--primary),var(--primary2));
    color:#fff;
    padding:18px 16px;
    position:sticky; top:0; z-index:10;
    box-shadow:0 8px 20px rgba(2,6,23,.08);
  }
  header .title{
    max-width:1100px; margin:0 auto;
    font-size:20px; font-weight:800;
  }

  .container{
    max-width:1100px;
    margin:16px auto;
    padding:0 12px 24px;
    display:grid;
    grid-template-columns: 360px 1fr;
    gap:14px;
  }

  @media (max-width: 900px){
    .container{grid-template-columns:1fr}
  }

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:0 10px 25px rgba(2,6,23,.06);
    overflow:hidden;
  }

  .card .card-h{
    padding:12px 14px;
    border-bottom:1px solid var(--border);
    font-weight:800;
  }

  .card .card-b{
    padding:14px;
  }

  label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
  input, select, textarea{
    width:100%;
    border:1px solid var(--border);
    background:#fff;
    border-radius:10px;
    padding:10px 10px;
    font-size:14px;
    outline:none;
  }
  textarea{min-height:84px; resize:vertical}

  input:focus, select:focus, textarea:focus{
    border-color:#93c5fd;
    box-shadow:0 0 0 3px rgba(59,130,246,.15);
  }

  .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
  @media (max-width: 900px){
    .row,.row3{grid-template-columns:1fr}
  }

  .btn{
    display:inline-flex; align-items:center; justify-content:center;
    gap:8px;
    border:0;
    padding:10px 12px;
    border-radius:10px;
    cursor:pointer;
    font-weight:700;
  }
  .btn-primary{background:var(--primary); color:#fff}
  .btn-primary:hover{background:var(--primary2)}
  .btn-ghost{background:#eef2ff; color:#1e3a8a}
  .btn-ghost:hover{background:#e0e7ff}

  .small{font-size:12px; color:var(--muted)}

  /* right panel */
  .filters{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .filters > *{flex:1; min-width:160px}
  .filters .btn{flex:0}

  #listings .card-item{
    border:1px solid var(--border);
    border-radius:12px;
    padding:12px;
    margin-top:10px;
  }
  #listings .card-item b{font-size:15px}
  #listings .meta{color:var(--muted); font-size:12px; margin-top:4px}
  #listings .actions{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap}
  #listings a{color:var(--primary); text-decoration:none}
  #listings a:hover{text-decoration:underline}

  /* map */
  .map-wrap{max-width:1100px; margin:0 auto 24px; padding:0 12px;}
  #map{
    height:420px;
    border-radius:var(--radius);
    border:1px solid var(--border);
    box-shadow:0 10px 25px rgba(2,6,23,.06);
    overflow:hidden;
  }

  .consent{
    display:flex; gap:10px; align-items:flex-start;
    font-size:12px; color:var(--muted);
  }
  .consent input{width:auto; margin-top:2px}
.contact-badge{
  display:inline-block;
  background:#16a34a;   /* สีพื้นหลังเขียว */
  color:#ffffff;        /* ตัวอักษรสีขาว */
  padding:6px 12px;
  border-radius:8px;
  font-size:13px;
  font-weight:600;
}

</style>

</head>
<body>
 <header>
  <div class="title">Estate-Data-Center • รวมประกาศอสังหา (ทดลอง)</div>
</header>

<div class="container">

  <!-- LEFT: Form -->
  <div class="card">
    <div class="card-h">ลงประกาศขาย (ต้องรออนุมัติ)</div>
    <div class="card-b">
      <form id="sellForm" style="display:grid; gap:10px;">
        <div>
          <label>ชื่อ (หรือชื่อ-นามสกุล)</label>
          <input id="fullName" placeholder="เช่น จตุรนต์" required />
        </div>

        <div>
          <label>เบอร์โทรหรือไลน์</label>
          <input id="contact" placeholder="เช่น 089xxxxxxx หรือ Line: abc" required />
        </div>

        <div class="row">
          <div>
            <label>จังหวัด</label>
            <select id="province" required></select>
          </div>
          <div>
            <label>ประเภท</label>
            <select id="type" required>
              <option value="">เลือกประเภท</option>
              <option value="land">ที่ดิน</option>
              <option value="house">บ้าน</option>
              <option value="condo">คอนโด</option>
            </select>
          </div>
        </div>

        <div>
          <label>หัวข้อประกาศ</label>
          <input id="title" placeholder="เช่น ที่ดินติดถนน" required />
        </div>

        <div class="row">
          <div>
            <label>ราคา (บาท)</label>
            <input id="price" type="number" placeholder="เช่น 1200000" required />
          </div>
          <div>
            <label>ตำแหน่ง (ไม่ใส่ก็ได้)</label>
            <div class="row">
              <input id="lat" placeholder="lat" />
              <input id="lng" placeholder="lng" />
            </div>
          </div>
        </div>

        <div>
          <label>รายละเอียด</label>
          <textarea id="detail" placeholder="ขนาด, ทำเล, จุดเด่น"></textarea>
        </div>

        <label class="consent">
          <input type="checkbox" id="consent" required />
          <span>ยินยอมให้เผยแพร่ “ข้อมูลประกาศ + ช่องทางติดต่อ” บนเว็บไซต์</span>
        </label>

        <button class="btn btn-primary" type="submit">ส่งประกาศ</button>
        <div id="formMsg" class="small"></div>
      </form>

      <div class="small" style="margin-top:10px;">
        * หลังส่งแล้วจะเป็น <b>PENDING</b> ในชีต → คุณค่อยเปลี่ยนเป็น <b>APPROVED</b> เพื่อให้ขึ้นหน้าเว็บ
      </div>
    </div>
  </div>

  <!-- RIGHT: Search + Listings -->
  <div class="card">
    <div class="card-h">ค้นหาและดูรายการ</div>
    <div class="card-b">
      <div class="filters">
        <select id="provinceSelect">
          <option value="">ทุกจังหวัด</option>
        </select>

        <select id="typeSelect">
          <option value="">ทุกประเภท</option>
          <option value="land">ที่ดิน</option>
          <option value="house">บ้าน</option>
          <option value="condo">คอนโด</option>
        </select>

        <input id="searchInput" placeholder="ค้นหา เช่น ชื่อประกาศ / เบอร์ / จังหวัด" />
        <button class="btn btn-ghost" id="resetBtn" type="button">รีเซ็ต</button>
      </div>

      <div id="listings"></div>
    </div>
  </div>

</div>

<div class="map-wrap">
  <div id="map"></div>
</div>


  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzuKt4qWsyJfTYYLJf4BNUmztBo-jFV7a2vCULgJ2SuzOWOxHII94gJQzTANBP4G0b00w/exec";
    let map = L.map('map').setView([13.7367, 100.5231], 5); // ค่าเริ่มต้น: กรุงเทพ
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let markers = L.layerGroup().addTo(map);
    let allListings = [];

    async function loadListings(){
      const res = await fetch('listings.json');
      const data = await res.json();
      allListings = data;
      populateProvinceOptions();
      render(allListings);
    }

    function populateProvinceOptions(){
      const set = new Set(allListings.map(l=>l.province).filter(Boolean));
      const sel = document.getElementById('provinceSelect');
      set.forEach(p=>{
        const opt = document.createElement('option'); opt.value = p; opt.textContent = p;
        sel.appendChild(opt);
      });
    }

   function render(list){
  markers.clearLayers();
  const container = document.getElementById('listings');
  container.innerHTML = '';

  if(!list || list.length === 0){
    container.innerHTML = '<i class="small">ไม่มีรายการ</i>';
    return;
  }

  list.forEach(item => {
    const contact = item.contact || item.phone || ''; // รองรับทั้งข้อมูลจากชีตและ listings.json
    const priceText = item.price ? '฿' + Number(item.price).toLocaleString() : '-';

    // ===== map marker =====
    if(item.lat && item.lng){
      const m = L.marker([Number(item.lat), Number(item.lng)]).addTo(markers);
      m.bindPopup(`
        <b>${item.title || '-'}</b><br>
        ${item.province || '-'} • ${item.type || '-'}<br>
        ราคา: ${priceText}<br>
        ${contact ? `<a href="tel:${contact}">โทร/ติดต่อ: ${contact}</a>` : ``}
      `);
    }

    // ===== list card (สวยแบบ card-item) =====
    const card = document.createElement('div');
    card.className = 'card-item';
    card.innerHTML = `
      <b>${item.title || '-'}</b>
      <div class="meta">${item.province || '-'} • ${item.type || '-'} • ราคา: ${priceText}</div>
      ${item.detail ? `<div style="margin-top:8px;">${item.detail}</div>` : ``}

      <div class="actions">
        ${contact ? `<a class="btn btn-primary" style="text-decoration:none" href="tel:${contact}">โทร/ติดต่อ</a>` : ``}
        ${contact ? `<span class="contact-badge">ติดต่อ: <b>${contact}</b></span>
` : `<span class="small">ยังไม่มีช่องทางติดต่อ</span>`}
      </div>
    `;
    container.appendChild(card);
  });
}


    // filters
    document.getElementById('provinceSelect').addEventListener('change', applyFilters);
    document.getElementById('typeSelect').addEventListener('change', applyFilters);
    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      document.getElementById('provinceSelect').value='';
      document.getElementById('typeSelect').value='';
      document.getElementById('searchInput').value='';
      render(allListings);
    });

    function applyFilters(){
      const prov = document.getElementById('provinceSelect').value.trim().toLowerCase();
      const type = document.getElementById('typeSelect').value;
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      const filtered = allListings.filter(i=>{
        if(prov && (i.province||'').toLowerCase() !== prov) return false;
        if(type && i.type !== type) return false;
        if(q){
          const s = `${i.title} ${(i.contact || i.phone || '')} ${i.province} ${i.type}`.toLowerCase();
          if(!s.includes(q)) return false;
        }
        return true;
      });
      render(filtered);
    }

    loadListings();
    const PROVINCES_TH = [
  "กรุงเทพมหานคร","กระบี่","กาญจนบุรี","กาฬสินธุ์","กำแพงเพชร","ขอนแก่น","จันทบุรี","ฉะเชิงเทรา",
  "ชลบุรี","ชัยนาท","ชัยภูมิ","ชุมพร","เชียงราย","เชียงใหม่","ตรัง","ตราด","ตาก","นครนายก",
  "นครปฐม","นครพนม","นครราชสีมา","นครศรีธรรมราช","นครสวรรค์","นนทบุรี","นราธิวาส","น่าน",
  "บึงกาฬ","บุรีรัมย์","ปทุมธานี","ประจวบคีรีขันธ์","ปราจีนบุรี","ปัตตานี","พระนครศรีอยุธยา",
  "พะเยา","พังงา","พัทลุง","พิจิตร","พิษณุโลก","เพชรบุรี","เพชรบูรณ์","แพร่","ภูเก็ต","มหาสารคาม",
  "มุกดาหาร","แม่ฮ่องสอน","ยโสธร","ยะลา","ร้อยเอ็ด","ระนอง","ระยอง","ราชบุรี","ลพบุรี","ลำปาง",
  "ลำพูน","เลย","ศรีสะเกษ","สกลนคร","สงขลา","สตูล","สมุทรปราการ","สมุทรสงคราม","สมุทรสาคร",
  "สระแก้ว","สระบุรี","สิงห์บุรี","สุโขทัย","สุพรรณบุรี","สุราษฎร์ธานี","สุรินทร์","หนองคาย",
  "หนองบัวลำภู","อ่างทอง","อำนาจเจริญ","อุดรธานี","อุตรดิตถ์","อุทัยธานี","อุบลราชธานี"
];

function fillProvinces(){
  const sel = document.getElementById('province');
  if(!sel) return;
  sel.innerHTML = `<option value="">เลือกจังหวัด</option>`;
  PROVINCES_TH.forEach(p=>{
    const opt = document.createElement('option');
    opt.value = p;
    opt.textContent = p;
    sel.appendChild(opt);
  });
}

async function loadApprovedFromSheet(){
  const res = await fetch(`${API_URL}?status=APPROVED`);
  const data = await res.json();
  if(!data.ok) throw new Error(data.error || "โหลดข้อมูลไม่สำเร็จ");
  return data.listings || [];
}

async function submitToSheet(payload){
  const res = await fetch(API_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  return await res.json();
}

document.addEventListener("DOMContentLoaded", async ()=>{
  fillProvinces();

  // โหลดข้อมูลเดิมจาก listings.json
  await loadListings();

  // โหลดข้อมูลที่ APPROVED จาก Google Sheet แล้วรวมแสดง
  try{
    const approved = await loadApprovedFromSheet();
    const merged = [...approved, ...allListings];
    render(merged);
  }catch(err){
    console.log(err);
    render(allListings);
  }

  const form = document.getElementById("sellForm");
  if(form){
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const msg = document.getElementById("formMsg");
      msg.textContent = "กำลังส่ง...";

      const payload = {
        full_name: document.getElementById("fullName").value.trim(),
        contact: document.getElementById("contact").value.trim(),
        province: document.getElementById("province").value,
        type: document.getElementById("type").value,
        title: document.getElementById("title").value.trim(),
        price: document.getElementById("price").value,
        lat: document.getElementById("lat").value.trim(),
        lng: document.getElementById("lng").value.trim(),
        detail: document.getElementById("detail").value.trim()
      };

      try{
        const r = await submitToSheet(payload);
        if(r.ok){
          msg.textContent = "ส่งประกาศแล้ว ✅ รออนุมัติ ก่อนขึ้นหน้าเว็บ";
          form.reset();
          fillProvinces();
        }else{
          msg.textContent = "ส่งไม่สำเร็จ: " + (r.error || "ไม่ทราบสาเหตุ");
        }
      }catch(err){
        msg.textContent = "ส่งไม่สำเร็จ: " + err.message;
      }
    });
  }
});


  </script>
</body>
</html>







