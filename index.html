<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <title>Estate-Data-Center</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#f6f8fb; --card:#ffffff; --text:#0f172a; --muted:#64748b;
      --border:#e2e8f0; --primary:#0b74de; --primary2:#095db1; --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Thai","Noto Sans",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      background:linear-gradient(90deg,var(--primary),var(--primary2));
      color:#fff;
      padding:16px 12px;
      position:sticky; top:0; z-index:10;
      box-shadow:0 8px 20px rgba(2,6,23,.08);
    }
    header .title{
      max-width:1100px; margin:0 auto;
      font-size:18px; font-weight:800;
      text-align:center;
      line-height:1.2;
    }

    .container{
      max-width:1100px;
      margin:16px auto;
      padding:0 12px 24px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
    }
    @media (max-width: 900px){
      .container{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:0 10px 25px rgba(2,6,23,.06);
      overflow:hidden;
    }
    .card .card-h{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      font-weight:800;
    }
    .card .card-b{padding:14px;}

    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input, select, textarea{
      width:100%;
      border:1px solid var(--border);
      background:#fff;
      border-radius:10px;
      padding:10px 10px;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:84px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color:#93c5fd;
      box-shadow:0 0 0 3px rgba(59,130,246,.15);
    }

    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 900px){ .row{grid-template-columns:1fr} }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      border:0;
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      user-select:none;
    }
    .btn-primary{background:#1d4ed8; color:#fff}
    .btn-primary:hover{background:#1e40af}
    .btn-ghost{background:#eef2ff; color:#1e3a8a}
    .btn-ghost:hover{background:#e0e7ff}
    .btn-danger{background:#fee2e2; color:#991b1b}
    .btn-danger:hover{background:#fecaca}
    .small{font-size:12px; color:var(--muted)}
    .consent{display:flex; gap:10px; align-items:flex-start; font-size:12px; color:var(--muted);}
    .consent input{width:auto; margin-top:2px}

    .filters{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .filters > *{flex:1; min-width:160px}
    .filters .btn{flex:0}

    #listings .card-item{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      margin-top:10px;
      background:#fff;
    }
    #listings .card-item b{font-size:15px}
    #listings .meta{color:var(--muted); font-size:12px; margin-top:4px}
    #listings .actions{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:10px;
      font-size:13px;
      font-weight:800;
      white-space:nowrap;
    }
    .badge-contact{background:#16a34a; color:#ffffff;}
    .badge-sold{background:#64748b; color:#ffffff;}
    .badge-avail{background:#16a34a; color:#ffffff;}

    .thumbs{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .thumb{
      width:78px; height:78px;
      border-radius:10px;
      object-fit:cover;
      border:1px solid var(--border);
      cursor:pointer;
      background:#f1f5f9;
    }

    .map-wrap{max-width:1100px; margin:0 auto 24px; padding:0 12px;}
    #map{
      height:420px;
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow:0 10px 25px rgba(2,6,23,.06);
      overflow:hidden;
    }

    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(2,6,23,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:14px;
    }
    .modal{
      width:min(820px, 94vw);
      background:#fff;
      border-radius:14px;
      border:1px solid var(--border);
      box-shadow:0 20px 60px rgba(2,6,23,.25);
      overflow:hidden;
    }
    .modal-h{
      padding:12px 14px;
      font-weight:800;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .modal-b{padding:14px}
    .modal-x{border:0; background:transparent; font-size:18px; cursor:pointer}
    .gallery-img{
      width:100%;
      max-height:70vh;
      object-fit:contain;
      background:#0b1220;
      border-radius:12px;
    }

    .img-box{
      border:1px dashed var(--border);
      border-radius:12px;
      padding:12px;
      background:#fff;
      cursor:pointer;
    }
    .img-box:hover{
      border-color:#93c5fd;
      box-shadow:0 0 0 3px rgba(59,130,246,.12)
    }

    .login-row{
      max-width:1100px;
      margin:10px auto 0;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .login-status{
      font-size:12px;
      opacity:0.95;
      background:rgba(255,255,255,.15);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
    }
  </style>
</head>

<body>
<header>
  <div class="title">Estate-Data-Center • รวมประกาศอสังหา (ทดลอง)</div>
  <div class="login-row">
    <div class="login-status" id="loginStatus">ยังไม่ได้ล็อกอิน</div>
    <button class="btn btn-ghost" id="logoutBtn" type="button" style="display:none;">ออกจากระบบ</button>
    <div id="gSignIn"></div>
  </div>
</header>

<div class="container">

  <div class="card">
    <div class="card-h">ลงประกาศขาย (ต้องรออนุมัติ)</div>
    <div class="card-b">
      <form id="sellForm" style="display:grid; gap:10px;">

        <input type="hidden" id="editing_id" value="" />
        <input type="hidden" id="images" value="[]"/>

        <div>
          <label>ชื่อ (หรือชื่อ-นามสกุล)</label>
          <input id="fullName" placeholder="ชื่อ-นามสกุล" required />
        </div>

        <div>
          <label>เบอร์โทรหรือไลน์</label>
          <input id="contact" placeholder="เช่น 089xxxxxxx หรือ Line: abc" required />
        </div>

        <div class="row">
          <div>
            <label>จังหวัด</label>
            <select id="province" required></select>
          </div>
          <div>
            <label>ประเภท</label>
            <select id="type" required>
              <option value="">เลือกประเภท</option>
              <option value="land">ที่ดิน</option>
              <option value="house">บ้าน</option>
              <option value="condo">คอนโด</option>
            </select>
          </div>
        </div>

        <div>
          <label>หัวข้อประกาศ</label>
          <input id="title" placeholder="เช่น ที่ดินติดถนน" required />
        </div>

        <div class="row">
          <div>
            <label>ราคา (บาท)</label>
            <input id="price" type="number" placeholder="เช่น 1200000" required />
          </div>
          <div>
            <label>ตำแหน่ง (ไม่ใส่ก็ได้)</label>
            <div class="row">
              <input id="lat" placeholder="lat" />
              <input id="lng" placeholder="lng" />
            </div>
          </div>
        </div>

        <div>
          <label>รายละเอียด</label>
          <textarea id="detail" placeholder="ขนาด, ทำเล, จุดเด่น"></textarea>
        </div>

        <div>
          <label>สถานะทรัพย์</label>
          <select id="sold_status" required>
            <option value="ยังไม่ขาย">ยังไม่ขาย</option>
            <option value="ขายแล้ว">ขายแล้ว</option>
          </select>
        </div>

        <div class="img-box" id="imgBox" role="button" tabindex="0">
          รูปภาพ (กดเพื่อใส่/แก้ไขลิงก์รูป)
          <div class="small" id="imgCount">ยังไม่เลือกรูป</div>
        </div>

        <button class="btn btn-ghost" id="pasteLinkBtn" type="button">ใส่ลิงก์รูปเอง</button>

        <label class="consent">
          <input type="checkbox" id="consent" required />
          <span>ยินยอมให้เผยแพร่ “ข้อมูลประกาศ + ช่องทางติดต่อ” บนเว็บไซต์</span>
        </label>

        <button class="btn btn-primary" type="submit" id="submitBtn">ส่งประกาศ</button>
        <div id="formMsg" class="small"></div>

        <div class="small">
          * ส่งแล้วจะเป็น <b>PENDING</b> ในชีต → คุณค่อยเปลี่ยนเป็น <b>APPROVED</b> เพื่อให้ขึ้นหน้าเว็บ  
          <br>* ถ้าแก้ไข จะอัปเดต “โพสต์เดิม” และกลับเป็น <b>PENDING</b> เพื่ออนุมัติใหม่
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-h">ค้นหาและดูรายการ</div>
    <div class="card-b">
      <div class="filters">
        <select id="provinceSelect"><option value="">ทุกจังหวัด</option></select>
        <select id="typeSelect">
          <option value="">ทุกประเภท</option>
          <option value="land">ที่ดิน</option>
          <option value="house">บ้าน</option>
          <option value="condo">คอนโด</option>
        </select>
        <select id="soldSelect">
          <option value="">ทุกสถานะ</option>
          <option value="ยังไม่ขาย">ยังไม่ขาย</option>
          <option value="ขายแล้ว">ขายแล้ว</option>
        </select>
        <input id="searchInput" placeholder="ค้นหา เช่น ชื่อประกาศ / เบอร์ / จังหวัด" />
        <button class="btn btn-ghost" id="resetBtn" type="button">รีเซ็ต</button>
      </div>

      <div id="listings"></div>
    </div>
  </div>
</div>

<div class="map-wrap">
  <div id="map"></div>
</div>

<div class="modal-backdrop" id="imgModal">
  <div class="modal">
    <div class="modal-h">
      <div>เพิ่มรูปภาพ (ใส่ลิงก์รูปทีละบรรทัด)</div>
      <button class="modal-x" id="imgModalClose">✕</button>
    </div>
    <div class="modal-b">
      <textarea id="imgUrls" placeholder="วางลิงก์รูป 1 บรรทัดต่อ 1 รูป"></textarea>
      <div style="margin-top:10px;display:flex;gap:10px;justify-content:flex-end;">
        <button class="btn btn-ghost" id="imgModalCancel" type="button">ยกเลิก</button>
        <button class="btn btn-primary" id="imgModalSave" type="button">บันทึก</button>
      </div>
      <div class="small" style="margin-top:10px;">
        * ต้องเป็นลิงก์รูปที่เปิดสาธารณะ (jpg/png/webp)
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="galleryModal">
  <div class="modal">
    <div class="modal-h">
      <div>รูปภาพ</div>
      <button class="modal-x" id="galleryClose">✕</button>
    </div>
    <div class="modal-b">
      <img id="galleryImg" class="gallery-img" src="" alt="gallery"/>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbwybvSikdUzvuwOHTJM9W9Zq3JNWJ8RLbm-pH6lW04YGVVmBJqaIXUDpr1dUnnCUseVgw/exec";
  const GOOGLE_CLIENT_ID = "86449545414-but5pc5o9ocri2eurd016aaolfpktbh9.apps.googleusercontent.com";

  const PROVINCES_TH = [
    "กรุงเทพมหานคร","กระบี่","กาญจนบุรี","กาฬสินธุ์","กำแพงเพชร","ขอนแก่น","จันทบุรี","ฉะเชิงเทรา",
    "ชลบุรี","ชัยนาท","ชัยภูมิ","ชุมพร","เชียงราย","เชียงใหม่","ตรัง","ตราด","ตาก","นครนายก",
    "นครปฐม","นครพนม","นครราชสีมา","นครศรีธรรมราช","นครสวรรค์","นนทบุรี","นราธิวาส","น่าน",
    "บึงกาฬ","บุรีรัมย์","ปทุมธานี","ประจวบคีรีขันธ์","ปราจีนบุรี","ปัตตานี","พระนครศรีอยุธยา",
    "พะเยา","พังงา","พัทลุง","พิจิตร","พิษณุโลก","เพชรบุรี","เพชรบูรณ์","แพร่","ภูเก็ต","มหาสารคาม",
    "มุกดาหาร","แม่ฮ่องสอน","ยโสธร","ยะลา","ร้อยเอ็ด","ระนอง","ระยอง","ราชบุรี","ลพบุรี","ลำปาง",
    "ลำพูน","เลย","ศรีสะเกษ","สกลนคร","สงขลา","สตูล","สมุทรปราการ","สมุทรสงคราม","สมุทรสาคร",
    "สระแก้ว","สระบุรี","สิงห์บุรี","สุโขทัย","สุพรรณบุรี","สุราษฎร์ธานี","สุรินทร์","หนองคาย",
    "หนองบัวลำภู","อ่างทอง","อำนาจเจริญ","อุดรธานี","อุตรดิตถ์","อุทัยธานี","อุบลราชธานี"
  ];

  let currentUser = null; // {email, id_token}
  let allListings = [];
  let approvedListings = [];

  let map, markers;
  function initMap(){
    map = L.map('map').setView([13.7367, 100.5231], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(map);
    markers = L.layerGroup().addTo(map);
  }

  function updateLoginStatus(){
    const el = document.getElementById("loginStatus");
    const outBtn = document.getElementById("logoutBtn");
    if(currentUser?.email){
      el.textContent = "ล็อกอินแล้ว: " + currentUser.email;
      outBtn.style.display = "";
    }else{
      el.textContent = "ยังไม่ได้ล็อกอิน";
      outBtn.style.display = "none";
    }
  }

  document.getElementById("logoutBtn").addEventListener("click", ()=>{
    currentUser = null;
    localStorage.removeItem("id_token");
    updateLoginStatus();
    renderMerged();
    alert("ออกจากระบบแล้ว");
  });

  function fillProvinces(){
    const sel = document.getElementById('province');
    sel.innerHTML = `<option value="">เลือกจังหวัด</option>`;
    PROVINCES_TH.forEach(p=>{
      const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = p;
      sel.appendChild(opt);
    });
  }

  function populateProvinceOptionsFrom(list){
    const sel = document.getElementById('provinceSelect');
    sel.innerHTML = `<option value="">ทุกจังหวัด</option>`;
    const set = new Set(list.map(l => l.province).filter(Boolean));
    [...set].sort().forEach(p=>{
      const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = p;
      sel.appendChild(opt);
    });
  }

  function canManage(item){
    return currentUser?.email && String(item.owner_email||"").trim() === currentUser.email;
  }

  function parseImages(x){
    try{
      if(Array.isArray(x)) return x.map(s=>String(s).trim()).filter(Boolean);
      if(typeof x === "string") return JSON.parse(x || "[]").map(s=>String(s).trim()).filter(Boolean);
      return [];
    }catch(e){ return []; }
  }

  function setImages(arr){
    const clean = (arr || []).map(s=>String(s).trim()).filter(Boolean);
    document.getElementById("images").value = JSON.stringify(clean);
    document.getElementById("imgCount").textContent = clean.length ? `เลือกรูปแล้ว ${clean.length} รูป` : "ยังไม่เลือกรูป";
  }
  function getImages(){
    try{ return JSON.parse(document.getElementById("images").value || "[]"); }
    catch(e){ return []; }
  }

  async function loadLocalListings(){
    try{
      const res = await fetch("listings.json");
      allListings = await res.json();
      if(!Array.isArray(allListings)) allListings = [];
    }catch(e){ allListings = []; }
  }

 async function loadApprovedFromSheet(){
  const res = await fetch(`${API_URL}?status=APPROVED`);
  const data = await res.json();
  if(!data.ok) throw new Error(data.error || "โหลดข้อมูลไม่สำเร็จ");

  // ✅ กรองทิ้งรายการที่ลบ/ซ่อน
  return (data.listings || []).filter(x => String(x.status || "").toUpperCase() !== "DELETED");
}


  function mergedListings(){
    return [...approvedListings, ...allListings].filter(x => String(x.status||"").toUpperCase() !== "DELETED");
  }
  function renderMerged(){
    const merged = mergedListings();
    populateProvinceOptionsFrom(merged);
    render(merged);
  }

  function submitToSheet(payload){
  return new Promise((resolve, reject)=>{
    if(!currentUser?.id_token){
      alert("ต้องล็อกอินด้วย Gmail ก่อน");
      return reject(new Error("not logged in"));
    }

    const form = document.createElement("form");
    form.method = "POST";
    form.action = API_URL;
    form.target = "hidden_iframe";

    const iframe = document.getElementById("hidden_iframe") || (()=> {
      const ifr = document.createElement("iframe");
      ifr.name = "hidden_iframe";
      ifr.id = "hidden_iframe";
      ifr.style.display = "none";
      document.body.appendChild(ifr);
      return ifr;
    })();

    const data = {...payload, id_token: currentUser.id_token};
    Object.keys(data).forEach(k=>{
      const inp = document.createElement("input");
      inp.type = "hidden";
      inp.name = k;
      inp.value = data[k];
      form.appendChild(inp);
    });

    // Apps Script จะ redirect/ตอบกลับหน้าใหม่ใน iframe
    // เราอ่านผล JSON ไม่ได้เพราะ cross-origin
    // วิธีนี้ให้ “ถือว่าสำเร็จ” แล้วค่อย reload รายการจาก GET แทน
    iframe.onload = async ()=>{
      form.remove();
      // reload รายการใหม่จาก GET เพื่อยืนยันผล
      try{
        await loadApprovedFromSheet();
        renderMerged();
        resolve({ok:true});
      }catch(e){
        resolve({ok:true}); // ถึงโหลดไม่ผ่านก็ยังถือว่าส่งได้
      }
    };

    document.body.appendChild(form);
    form.submit();
  });
}


  function render(list){
    list = (list || []).filter(x => String(x.status || "").toUpperCase() !== "DELETED");

    markers.clearLayers();
    const container = document.getElementById("listings");
    container.innerHTML = "";

    if(!list || list.length === 0){
      container.innerHTML = `<i class="small">ไม่มีรายการ</i>`;
      return;
    }

    list.forEach(item=>{
      const priceText = item.price ? "฿" + Number(item.price).toLocaleString() : "-";
      const contact = item.contact || "-";
      const sold = (item.sold_status || "ยังไม่ขาย").trim();
      const images = parseImages(item.images);

      if(item.lat && item.lng){
        const lat = Number(item.lat), lng = Number(item.lng);
        if(!Number.isNaN(lat) && !Number.isNaN(lng)){
          const m = L.marker([lat, lng]).addTo(markers);
          m.bindPopup(`<b>${item.title || "-"}</b><br>${item.province || "-"} • ${item.type || "-"}<br>ราคา: ${priceText}`);
        }
      }

      const card = document.createElement("div");
      card.className = "card-item";

      const thumbsHtml = images.slice(0,8).map((u,idx)=>`
        <img class="thumb" src="${u}" alt="img"
             referrerpolicy="no-referrer"
             onerror="this.style.display='none'"
             data-idx="${idx}">
      `).join("");

      card.innerHTML = `
        <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
          <b>${item.title || "-"}</b>
          <span class="badge ${sold==="ขายแล้ว" ? "badge-sold" : "badge-avail"}">${sold}</span>
        </div>

        <div class="meta">${item.province || "-"} • ${item.type || "-"} • ราคา: ${priceText}</div>
        ${item.detail ? `<div style="margin-top:8px;">${item.detail}</div>` : ``}
        ${images.length ? `<div class="thumbs">${thumbsHtml}</div>` : ``}

        <div class="actions">
          <span class="badge badge-contact">ติดต่อ: <b>${contact}</b></span>

          ${
            canManage(item)
            ? `
              <button class="btn btn-ghost btn-edit" type="button">แก้ไข</button>
              <button class="btn btn-danger btn-del" type="button">ลบ</button>
              <select class="btn btn-ghost btn-sold" style="padding:10px;border:1px solid #e2e8f0">
                <option value="ยังไม่ขาย" ${sold==="ยังไม่ขาย"?"selected":""}>ยังไม่ขาย</option>
                <option value="ขายแล้ว" ${sold==="ขายแล้ว"?"selected":""}>ขายแล้ว</option>
              </select>
            `
            : `<span class="small">* ปุ่มแก้ไข/ลบจะเห็นเฉพาะเจ้าของโพสต์</span>`
          }
        </div>
      `;

      container.appendChild(card);

      if(images.length){
        card.querySelectorAll(".thumb").forEach(img=>{
          img.addEventListener("click", ()=>{
            const idx = Number(img.getAttribute("data-idx") || "0");
            openGallery(images, idx);
          });
        });
      }

      if(canManage(item)){
        card.querySelector(".btn-edit").addEventListener("click", ()=>{
          document.getElementById("editing_id").value = item.id || "";
          document.getElementById("fullName").value = item.full_name || "";
          document.getElementById("contact").value = item.contact || "";
          document.getElementById("province").value = item.province || "";
          document.getElementById("type").value = item.type || "";
          document.getElementById("title").value = item.title || "";
          document.getElementById("price").value = item.price || "";
          document.getElementById("lat").value = item.lat || "";
          document.getElementById("lng").value = item.lng || "";
          document.getElementById("detail").value = item.detail || "";
          document.getElementById("sold_status").value = item.sold_status || "ยังไม่ขาย";
          setImages(parseImages(item.images));
          document.getElementById("formMsg").textContent = "โหมดแก้ไข: กดส่งเพื่ออัปเดตโพสต์เดิม (จะกลับเป็น PENDING เพื่ออนุมัติใหม่)";
          window.scrollTo({top:0, behavior:"smooth"});
        });

        card.querySelector(".btn-del").addEventListener("click", async ()=>{
          if(!confirm("ยืนยันลบโพสต์นี้?")) return;
          const msg = document.getElementById("formMsg");
          msg.textContent = "กำลังลบ...";

          try{
            const r = await submitToSheet({mode:"delete", id:item.id});
            if (r.ok) {
  // 1) เอารายการนี้ออกจากรายการที่โหลดจากชีต (เพื่อให้หายทันทีบนหน้าเว็บ)
  approvedListings = approvedListings.filter(x => String(x.id) !== String(item.id));

  // 2) รวมรายการใหม่ แล้ว render ใหม่
  const merged = [...approvedListings, ...allListings];
  populateProvinceOptionsFrom(merged);
  render(merged);

  // 3) แจ้งข้อความ
  const msg = document.getElementById("formMsg");
  if (msg) msg.textContent = "ลบแล้ว ✅";
  return;
}


        card.querySelector(".btn-sold").addEventListener("change", async (ev)=>{
          try{
            const sold_status = ev.target.value;
            const r = await submitToSheet({mode:"sold", id:item.id, sold_status});
            if(!r.ok) alert("อัปเดตสถานะไม่สำเร็จ: " + (r.error||""));
            await loadApprovedFromSheet();
            renderMerged();
          }catch(err){
            alert("อัปเดตสถานะไม่สำเร็จ: " + err.message);
          }
        });
      }
    });
  }

  function applyFilters(){
    const prov = document.getElementById('provinceSelect').value.trim().toLowerCase();
    const type = document.getElementById('typeSelect').value;
    const sold = document.getElementById('soldSelect').value;
    const q = document.getElementById('searchInput').value.trim().toLowerCase();

    const merged = mergedListings();
    const filtered = merged.filter(i=>{
      if(prov && (i.province||'').toLowerCase() !== prov) return false;
      if(type && (i.type||'') !== type) return false;
      if(sold && (i.sold_status||'ยังไม่ขาย') !== sold) return false;
      if(q){
        const s = `${i.title} ${(i.contact||'')} ${i.province} ${i.type}`.toLowerCase();
        if(!s.includes(q)) return false;
      }
      return true;
    });
    render(filtered);
  }

  document.getElementById('provinceSelect').addEventListener('change', applyFilters);
  document.getElementById('typeSelect').addEventListener('change', applyFilters);
  document.getElementById('soldSelect').addEventListener('change', applyFilters);
  document.getElementById('searchInput').addEventListener('input', applyFilters);
  document.getElementById('resetBtn').addEventListener('click', ()=>{
    document.getElementById('provinceSelect').value='';
    document.getElementById('typeSelect').value='';
    document.getElementById('soldSelect').value='';
    document.getElementById('searchInput').value='';
    renderMerged();
  });

  const imgModal = document.getElementById("imgModal");
  const openImgModal = ()=>{
    document.getElementById("imgUrls").value = getImages().join("\n");
    imgModal.style.display = "flex";
  };
  document.getElementById("imgBox").addEventListener("click", openImgModal);
  document.getElementById("pasteLinkBtn").addEventListener("click", openImgModal);
  document.getElementById("imgModalClose").onclick = ()=> imgModal.style.display="none";
  document.getElementById("imgModalCancel").onclick = ()=> imgModal.style.display="none";
  document.getElementById("imgModalSave").onclick = ()=>{
    const lines = document.getElementById("imgUrls").value.split("\n").map(s=>s.trim()).filter(Boolean);
    setImages(lines);
    imgModal.style.display="none";
  };

  const galleryModal = document.getElementById("galleryModal");
  function openGallery(images, idx){
    document.getElementById("galleryImg").src = images[idx] || "";
    galleryModal.style.display = "flex";
  }
  document.getElementById("galleryClose").onclick = ()=> galleryModal.style.display="none";

  document.getElementById("sellForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const msg = document.getElementById("formMsg");
    msg.textContent = "กำลังส่ง...";

    if(!currentUser?.id_token){
      msg.textContent = "ต้องล็อกอินด้วย Gmail ก่อน";
      return;
    }

    const id = document.getElementById("editing_id").value.trim();
    const payload = {
      full_name: document.getElementById("fullName").value.trim(),
      contact: document.getElementById("contact").value.trim(),
      province: document.getElementById("province").value,
      type: document.getElementById("type").value,
      title: document.getElementById("title").value.trim(),
      price: document.getElementById("price").value,
      lat: document.getElementById("lat").value.trim(),
      lng: document.getElementById("lng").value.trim(),
      detail: document.getElementById("detail").value.trim(),
      images: document.getElementById("images").value,
      sold_status: document.getElementById("sold_status").value
    };

    try{
      let r;
      if(id) r = await submitToSheet({mode:"update", id, ...payload});
      else r = await submitToSheet({mode:"create", ...payload});

      if(r.ok){
        msg.textContent = id ? "อัปเดตแล้ว ✅ (รออนุมัติใหม่)" : "ส่งประกาศแล้ว ✅ (รออนุมัติ)";
        e.target.reset();
        document.getElementById("editing_id").value = "";
        setImages([]);
        fillProvinces();
        await loadApprovedFromSheet();
        renderMerged();
      }else{
        msg.textContent = "ส่งไม่สำเร็จ: " + (r.error || "ไม่ทราบสาเหตุ");
      }
    }catch(err){
      msg.textContent = "ส่งไม่สำเร็จ: " + err.message;
    }
  });

  function decodeEmailFromIdToken(idToken){
    try{
      const parts = idToken.split(".");
      const payload = JSON.parse(atob(parts[1].replace(/-/g,'+').replace(/_/g,'/')));
      return payload.email || "";
    }catch(e){
      return "";
    }
  }

  function initGoogleLogin(){
    google.accounts.id.initialize({
      client_id: GOOGLE_CLIENT_ID,
      callback: (resp)=>{
        const id_token = resp.credential;
        localStorage.setItem("id_token", id_token);
        const email = decodeEmailFromIdToken(id_token);
        currentUser = { email, id_token };
        updateLoginStatus();
        renderMerged();
      }
    });

    google.accounts.id.renderButton(
      document.getElementById("gSignIn"),
      { theme:"outline", size:"large", text:"signin_with" }
    );

    const cached = localStorage.getItem("id_token");
    if(cached){
      const email = decodeEmailFromIdToken(cached);
      if(email) currentUser = { email, id_token: cached };
    }
    updateLoginStatus();
  }

  (async function init(){
    fillProvinces();
    setImages([]);
    initMap();

    await loadLocalListings();
    try{ await loadApprovedFromSheet(); }catch(e){ approvedListings = []; }

    renderMerged();
  })();

  window.addEventListener("load", ()=>{
    const timer = setInterval(()=>{
      if(window.google?.accounts?.id){
        clearInterval(timer);
        initGoogleLogin();
      }
    }, 200);
  });
</script>
</body>
</html>





